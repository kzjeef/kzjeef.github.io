<!doctype html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />



  <meta name="google-site-verification" content="cDFhyeCTjCtdiX_kTRM-f4YBtgdo30SXuvERbggq39E" />













  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.1" />






<meta property="og:type" content="website">
<meta property="og:title" content="Thinking beyond source code">
<meta property="og:url" content="http://www.thinksrc.com/page/5/index.html">
<meta property="og:site_name" content="Thinking beyond source code">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Thinking beyond source code">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    sidebar: {"position":"right","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://www.thinksrc.com/page/5/"/>





  <title>Thinking beyond source code</title>
  




<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-1633147-2', 'auto');
  ga('send', 'pageview');
</script>


  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?f1c3ad154ad58e9f01314ca420646c0d";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>










</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-right 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Thinking beyond source code</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">Recording my throughs</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-post " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://www.thinksrc.com/2010/08/09/android-vpn-porting.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jiejing Zhang">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://avatars0.githubusercontent.com/u/113606?v=3&s=460">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Thinking beyond source code">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2010/08/09/android-vpn-porting.html" itemprop="url">Android: 移植VPN相关的kernel 内容</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2010-08-09T02:08:09+08:00">
                2010-08-09
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/未分类/" itemprop="url" rel="index">
                    <span itemprop="name">未分类</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>关于Vpn的支持，android代码在2.6.29的code上是支持的，但是2.6.27的就不支持。 所以今天backport了一下。 这里做一下记录。</p>
<p>最新的代码在 http://android.git.kernel.org/?p=kernel/common.git;a=summary&nbsp;</p>
<p>git://android.git.kernel.org/kernel/common.git</p>
<p>git checkout origin/android-goldfish-2.6.29 -b android-goldfish-2.6.29</p>
<p>这个分支才有最新的东西。</p>
<p>这几条commit是关于VPN(pptp, l2tp)的：不过这是到2010年8月9日截止的，以后新的就要自己加了。</p>
<p>&nbsp;</p>
<p>c8706d4199cbbe86f370c55e9b84f94e79101a48<br>c50311620326bf4515e1e5aa4f85bbb816852701<br>7620ea508ae5fc623da4fc8ded8c8e10e65196b3<br>d89050258f0133ae56d586dd6d7345d473c9a216<br>f7f6469023c8c704157f9932a7639b70936d44b6</p>
<div>打上去以后， 到kernel menuconfig里面把几个Config都打开。</div>
<div>我这里就只有：</div>
<div>CONFIG_NET_KEY</div>
<div>CONFIG_NET_IPIP</div>
<div>CONFIG_INET_ESP</div>
<div>CONFIG_INET_TUNNEL</div>
<div>CONFIG_TUN</div>
<div>CONFIG_PPP_DEFLATE</div>
<div>CONFIG_PPP_BSDCOMP</div>
<div>CONFIG_PPP_MPPE</div>
<div>CONFIG_PPPOE</div>
<div>CONFIG_PPPOL2TP</div>
<div>CONFIG_PPPOLAC</div>
<div>CONFIG_PPPOPNS</div>
<div>用menuconfig把这些打开以后就可以了（还有一些选项他们打开以后会自动打开)</div>
<div>我这里有一个config文件，如果少了什么就自己配置了。&nbsp;http://thinksrc.com/media/agdrempibG9ncg0LEgVNZWRpYRiy0gkM/default_config?a=download</div>
<p>&nbsp;</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-post " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://www.thinksrc.com/2010/08/08/fs-test.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jiejing Zhang">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://avatars0.githubusercontent.com/u/113606?v=3&s=460">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Thinking beyond source code">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2010/08/08/fs-test.html" itemprop="url">Basic test after file system hack</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2010-08-08T09:23:19+08:00">
                2010-08-08
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/未分类/" itemprop="url" rel="index">
                    <span itemprop="name">未分类</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>This post only for record the how to basic test after a file system hack</p>
<p>Dan Carpenter wrote:</p>
<blockquote>
<p>On filesystem tests, you should always test them before submitting them. Everyone can create a small filesystem like this:</p><p></p>
<pre class="brush: bash;light: true; fontsize: 100; first-line: 1; ">dd if=/dev/zero of=block bs=1M count=4000
mkfs.btrfs block mkdir mnt
sudo mount -o loop -t btrfs block mnt/ </pre>
<p>Maybe untar a kernel on it or something...  <br>Not sure.  <br>But if you mess up a filesystem people get annoyed.  :P
</p></blockquote>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-post " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://www.thinksrc.com/2010/07/30/kchecker.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jiejing Zhang">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://avatars0.githubusercontent.com/u/113606?v=3&s=460">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Thinking beyond source code">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2010/07/30/kchecker.html" itemprop="url">kchecker - check your kernel code</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2010-07-30T01:10:06+08:00">
                2010-07-30
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/未分类/" itemprop="url" rel="index">
                    <span itemprop="name">未分类</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>kchecker is a Static source code check tools. It can find some buggy kmalloc usage and&nbsp;</p>
<p>You can get this tool under http://repo.or.cz/w/smatch.git</p>
<p><span style="font-family: 'Courier New', monospace; line-height: 18px; font-size: 12px; white-space: pre;">git clone git://repo.or.cz/smatch.git</span></p>
<pre class="brush: bash;fontsize: 100; first-line: 1; ">cd smatch
make -j4
sudo make install</pre>
<p>After then, you can find kchecker under&nbsp;./smatch_scripts/kchecker.<br> Lets try it.</p>
<pre>x@x-desktop:$kchecker  --spammy  fs/ubifs/journal.c
  CHK     include/linux/version.h
make[1]: &ldquo;include/asm-arm/mach-types.h&rdquo; is latest
  CHK     include/linux/utsrelease.h
  SYMLINK include/asm -&gt; include/asm-arm
  CALL    scripts/checksyscalls.sh
  CHECK   fs/ubifs/journal.c
fs/ubifs/journal.c +233 reserve_space(118) warn: inconsistent returns mutex:&amp;wbuf-&gt;io_mutex: locked (136,202,215) unlocked (169,184,219,233)
  CC      fs/ubifs/journal.o</pre>
<p>This script find some wrong usage of mutex. Lets have another try:</p>
<p><span style="font-family: 'Courier New', monospace; line-height: 18px; font-size: 12px; white-space: pre;">x@x-desktop$ kchecker --spammy drivers/video/mxc/mxc_ipuv3_fb.c</span></p>
<pre class="brush: bash;fontsize: 100; first-line: 1; ">  CHK     include/linux/version.h
  CHK     include/linux/utsrelease.h
  SYMLINK include/asm -&gt; include/asm-arm
  CALL    scripts/checksyscalls.sh
  CHECK   drivers/video/mxc/mxc_ipuv3_fb.c
drivers/video/mxc/mxc_ipuv3_fb.c +875 mxcfb_ioctl(181) warn: possible memory leak of 'mem'
drivers/video/mxc/mxc_ipuv3_fb.c +992 mxcfb_ioctl(298) warn: 'sem:&amp;mxc_fbi-&gt;alpha_flip_sem' is sometimes locked here and sometimes unlocked.
drivers/video/mxc/mxc_ipuv3_fb.c +1541 mxcfb_remove(5) warn: variable dereferenced before check 'fbi'
  CC      drivers/video/mxc/mxc_ipuv3_fb.o</pre>
<p>This time, it found some possible memory leak. And some buggy lock usage.</p>
<p>Have fun with this tool...</p>
<p>BTW, This link&nbsp;<a href="http://smatch.sourceforge.net/" target="_blank" rel="external">http://smatch.sourceforge.net/</a> shows how to check at compile all kernel code.</p>
<p>&nbsp;</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-post " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://www.thinksrc.com/2010/07/22/linux-atomic.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jiejing Zhang">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://avatars0.githubusercontent.com/u/113606?v=3&s=460">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Thinking beyond source code">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2010/07/22/linux-atomic.html" itemprop="url">Linux中的原子操作以及IA-32架构的原子操作</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2010-07-22T23:01:14+08:00">
                2010-07-22
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/未分类/" itemprop="url" rel="index">
                    <span itemprop="name">未分类</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>原子操作， 通常有几种实现方式， 加锁和使用CPU指令中实现的原子变量操作。</p>
<p>在Linux Kernel中，通常使用atomic_t系列的操作如atomic_set(), atomic_read()来操作。这里先看看几个平台的实现，然后再记录一下X86下面atomic变量的实现。</p>
<p>atomic_t 的结构是这样的：</p>
<p>&nbsp;</p>
<pre class="brush: bash;fontsize: 100; first-line: 1; ">typedef struct { volatile int counter; } atomic_t;<br><br>在这个结构体中只有一个加上了volatile的int的计数器。基本上大部分的平台下的atomc_read()实现都是<br>#define atomic_read(v)	((v)-&gt;counter)<br>这样一条来实现的。这是因为不管是X86的还是MIPS体系的架构下，都不会对于内存读写作重新排序。因为这个操作有一条指针解引用，所以它就是对内存进行操作。<br><br>但是对于原子变量的写操作却有比较大的不同：<br>比如</pre>
<p>arm V6以上：</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<pre class="brush: cpp;light: true; fontsize: 100; first-line: 1; ">#define atomic_read(v)&nbsp;&nbsp;&nbsp; ((v)-&gt;counter)<br>static inline void atomic_set(atomic_t *v, int i)<br>{<br>	unsigned long tmp;<br><br>	__asm__ __volatile__("@ atomic_setn"<br>"1:	ldrex	%0, [%1]n"<br>"	strex	%0, %2, [%1]n"<br>"	teq	%0, #0n"<br>"	bne	1b"<br>	: "=&amp;r" (tmp)<br>	: "r" (&amp;v-&gt;counter), "r" (i)<br>	: "cc");<br>}</pre>
<p>&nbsp;</p>
<p>是用一个strex, ldrex（互斥读内存和互斥写内存）,来写内存如果设置不成功，就继续重新读一次再写一次。虽然这样的操作看起来不是很高效，但是却简化了CPU的设计，在其他方面的提升可以抵消这样操作的损耗。</p>
<p>剩下的实现都#define atomic_set(v,i) ((v)-&gt;counter = (i))这样实现的。</p>
<p>看似和读一样，都只是一条简单的赋值操作。 但是如果要实现真正原子，只需要保证编译器老老实实的把这条读写操作变成对于内存的读写就可以了。 而加上volatile就是这个意思，防止编译器把这个变量放在某个寄存器里面进行优化，而是每次都编译成load, store, 或者其他的内存操作指令。</p>
<p>因为在这些构架中，对于内存的读写都是可以保证原子的。但是对于IA-32有一个例外，就是IA-32构架下只有4字节对其的内存操作才是原子性的。除非是你手动写汇编。这种不是4字节对齐的内存访问需要在手动汇编或者一些结构体定义的时候特别注意。</p>
<p>下面记录一下IA-32下的原子操作的实现。</p>
<p>在IA-32下，可以通过在汇编指令前面加入#LOCK来保证这个操作是原子的。但是这个指令实现的方式却是把BUS锁住的方式实现的，所以会很影响系统的吞吐量。其他的指令也会造成类似的效果：</p>
<p>* CMPXCHG指令，就是传说中的比较并交换。<br>* 设置B位到TSS寄存器中，这样保证任务切换的时候不会出现切换任务的情况。<br>* 更新段选择器的时候。<br>* 更新Page Direcotry, page table 的时候<br>* 相应中断的时候，中断控制器传输中断向量的时候。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-post " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://www.thinksrc.com/2010/06/04/linux-driver-dma-allocation-not-using-gfp_dma.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jiejing Zhang">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://avatars0.githubusercontent.com/u/113606?v=3&s=460">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Thinking beyond source code">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2010/06/04/linux-driver-dma-allocation-not-using-gfp_dma.html" itemprop="url">Linux Driver DMA allocation - not using GFP_DMA</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2010-06-04T01:05:53+08:00">
                2010-06-04
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/未分类/" itemprop="url" rel="index">
                    <span itemprop="name">未分类</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>Today, I remove our DMA_ZONE in Linux Kernel, that provides 48MiB memory using by system &amp; application, MUCH faster then before.</p>
<p>Why DMA_ZONE, I think this because of the usage of dma_alloc_coherent(), try to allocate&nbsp;continues memory, in our old driver, they use GFP_DMA to call this function, This will cause this function allocation memory from DMA_ZONE or failed. even you using GFP_DMA|GFP_KERNEL.&nbsp;</p>
<p>My change almost change GFP_DMA to GFP_KERNEL or just remove GFP_DMA.&nbsp;</p>
<p>The DMA_ZONE is a legacy design, it was&nbsp;originally&nbsp;design to support 24-bit ISA bus or some broken PCI device that can't access full 32-bit memory. Because DMA_ZONE always in low memory address, so if your system is not like this, just avoid this DMA_ZONE.&nbsp;</p>
<p>about DMA memory allocation:&nbsp;</p>
<p>[1] <a href="http://www.linuxjournal.com/article/6930?page=0,2" target="_blank" rel="external">http://www.linuxjournal.com/article/6930?page=0,2</a></p>
<p><a href="http://www.linuxjournal.com/article/6930?page=0,2" target="_blank" rel="external"></a>[2] LDD3 Chapter 15 , 4.3 section.&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-post " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://www.thinksrc.com/2010/05/26/linux-i18n-note.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jiejing Zhang">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://avatars0.githubusercontent.com/u/113606?v=3&s=460">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Thinking beyond source code">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2010/05/26/linux-i18n-note.html" itemprop="url">Linux I18N 笔记</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2010-05-26T07:17:41+08:00">
                2010-05-26
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/未分类/" itemprop="url" rel="index">
                    <span itemprop="name">未分类</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>今天看了James Su在2007年的北京google 开发者日讲的I18N国际化的视频， 这是youku的地址：<a href="http://v.youku.com/v_show/id_XNTczNzcyOA==.html" target="_blank" rel="external">http://v.youku.com/v_show/id_XNTczNzcyOA==.html</a></p>
<p>算是解开了几个基本对于国际化的问题，这里作一个笔记吧， 记在本子上老是会找不到。</p>
<p>UCS&nbsp; vs UNICODE</p>
<p>其实UCS 和 UNICODE 现在是一样的编码，但是在最初制定的时候是由两个组织制订的，后来两个组织发现一个世界不需要两套编码，就想办法合并了一下，所以就兼容了。</p>
<p>UCS里面有 UCS-2(16位) UCS-4 (32位) 之类的</p>
<p>UCS 其实只是一个字符的表格，规定哪个页那行哪列是哪个字符，而UNICODE则一些其他的东西。这里有一个链接八卦了一些历史，http://blog.chinaunix.net/u1/49491/showart_2209875.html。</p>
<p>说一下外码， 和内码。</p>
<p>以前一直不太理解什么叫做外码， 其实外码就是存储（比如存放在硬盘上）传输（比如网络传输）用的字符编码，比如UTF-8，ASCII，还有恶心的GB2312之类的。在函数里面，通常这个会简称为mbs (multi byte string)。外码是不定长的，比如UTF-8就是有可能是1个字节，最多也可能到4个字节。</p>
<p>而内码呢，就是在内存中的使用的字符存储，因为外码是不定长的，所以在编程和处理的时候就会比较麻烦，比如你想往前3个字符，如果在ASCII下面就是3个字节，而如果是中文，那么就是不是3个字节了。 这个指针就不好操作了。所以会有内码，内码是定长的，比如你用wchar_t, wint_t就可以了。英文种的缩写是 wcs(wide char string)。</p>
<p>有一定需要注意的， 就是只有定义了__STDC_ISO_10646__这个宏的以后才是使用的unicode。</p>
<p>Linux下面有一个locale的东西，这个东西就是控制是使用哪一种语言的，其中包含一批宏。你在shell下输入locale就能看到这些宏的值了。比如我的就是</p>
<p>kzj@t61:~$ locale<br>LANG=zh_CN.UTF-8<br>LANGUAGE=zh_CN.UTF-8<br>LC_CTYPE="zh_CN.UTF-8"<br>LC_NUMERIC="zh_CN.UTF-8"<br>LC_TIME="zh_CN.UTF-8"<br>LC_COLLATE="zh_CN.UTF-8"<br>LC_MONETARY="zh_CN.UTF-8"<br>LC_MESSAGES="zh_CN.UTF-8"<br>LC_PAPER="zh_CN.UTF-8"<br>LC_NAME="zh_CN.UTF-8"<br>LC_ADDRESS="zh_CN.UTF-8"<br>LC_TELEPHONE="zh_CN.UTF-8"<br>LC_MEASUREMENT="zh_CN.UTF-8"<br>LC_IDENTIFICATION="zh_CN.UTF-8"<br>LC_ALL=</p>
<p>我现在的外码是使用的zh_CN.UTF-8。</p>
<p>如果是有两个码，就需要转换了。你从文件中读入一个字符串到内存的时候。 你需要把这些字符串都处理成内码来使用。</p>
<p>Linux下面有两种方法。</p>
<p>一种是使用 mbstowcs(3) 一类的函数来进行转换， 这样转换过的函数就可以使用wprintf一系列的函数了。这种方法严重依赖于你的locale设置，如果你读入的文本的编码和你的locale不一样的话，乱码就和你招手了，因为它只是把locale设置的语言转换成你的内码。</p>
<p>在操作所有这些和locale有关的函数之前，都要调用setlocale，不然可能会错误。</p>
<p>第二种使用iconv(3)的函数进行编码转换，这个函数不依赖于你的locale设置，随便指定编码转换，比如你可以用这个函数实现的简体和繁体之间的转换功能。</p>
<p>常见的错误：</p>
<p>1. 直接在源代码里面写中文。。。 建议任何有不是ASCII的内容都用gettext作翻译。</p>
<p>2. 使用UCS-2是不够的， 最好使用UCS-4，因为UCS-2是16位的，就算是汉字只能存2完多，最新发的标准都有5万多个汉字了。 所以不够，或者使用UTF-8比较好。</p>
<p>3. 直接操作外码，记不记得以前，WIN 98？ 的时候经常有软件出现半个汉字的情况？ 所以要处理汉字之类的，总是先转换成内码再操作。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-post " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://www.thinksrc.com/2010/05/24/touchscreen-driver.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jiejing Zhang">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://avatars0.githubusercontent.com/u/113606?v=3&s=460">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Thinking beyond source code">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2010/05/24/touchscreen-driver.html" itemprop="url">experices on a linux touchscreen panel driver</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2010-05-24T23:11:22+08:00">
                2010-05-24
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/未分类/" itemprop="url" rel="index">
                    <span itemprop="name">未分类</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>"Write a good touch feel touchscreen panel driver"</p>
<p>Recently, I had re-factory three time of our touch panel driver.Every time re-factory with clear aim.</p>
<p>&nbsp;</p>
<p>Our product use a resistance touchscreen panel(about touchscreen&nbsp;panel, see [http://en.wikipedia.org/wiki/Touchscreen]), the touch screen&nbsp;use an adc(Analog-to-digital converter) convert the resistance change&nbsp;to the digital number, then these value should be calibration by&nbsp;algorithm like (tslib, [http://tslib.berlios.de/]) does. After that,&nbsp;these value is be a human readable coordinate. The event should report&nbsp;we user touch the touchscreen, and should report a touch up event&nbsp;notice service layer the user leave the touchscreen.&nbsp;</p>
<p>In linux, all of these use by api in (linux/input.h), such as :&nbsp;</p>
<p>input_report_abs();</p>
<p>input_event();</p>
<p>input_sync();</p>
<p>Our first version of driver using a kthread, a infinite while loop;</p>
<pre>void kthread_func() {
        while(1) {
                poll_event(x, y, touch); //get a event from adc driver.
                input_report_abs(x);    //here report the coordinate of touch event
                input_event(touch);     //here report the state of touch, 1
                                        //means touch down, 0 means touch up.
                input_sync();                   //sync means a complete event.
                sleep(delay);
        }
}
</pre>
<p>This design is very simple and clear, But it have some shortcoming.</p>
<p>1. the kthread is hard to control, it hard stop by the other thread,&nbsp;until it stop by itself. It will be problem we you want to&nbsp;suspend/resume driver.&nbsp;</p>
<p>2. There is a touchscreen use case, If you move quickly you finger on&nbsp;the touchscreen, maybe there is one or two event is touch leave the&nbsp;screen in the middle of this move. This should be ignore by&nbsp;&nbsp; driver. Excellent product like iPad, iPhone touchscreen have this&nbsp;feather. But in this implantation, the touch leave event will&nbsp;report.</p>
<p>The next version of this driver, we change few things.</p>
<p>1. use a single_threaded_workqueue instead of kthread, so we can stop&nbsp;the thread when the driver suspend.</p>
<p>2. in the workquque, it only report the down event and the abs change&nbsp;of the toucscreen, the touch up event is sent by a hrtimer. &nbsp;every&nbsp;time the work is running, it will adjust the timer. If there is no&nbsp;event coming, the timer is not modify by anyone, so it expired, the&nbsp;callback is called, it will send a touch up event.&nbsp;</p>
<p>pseudocode is:</p>
<pre>   timer_func()
   {
        input_report_abs(ABS_X, x);     //x,y coordinate
        input_report_abs(ABS_Y, y);
        input_report_abs(ABS_PRESSURE, 0); //pressure
        input_event(EV_KEY, BTN_TOUCH, 0); //touch up event
        input_sync();
   }

   workqueue_func()
   {

        poll_event(x, y, touch); //get a event from adc driver.
        start_hrtimer(timer, timeout_of_touch_up); //normally 2-10
                                                   //times of delay
        if (touch) {
                input_report_abs(x);    //here report the coordinate of touch event
                input_event(touch);     //here report the state of touch, 1
                                        //means touch down, 0 means touch up.
                input_sync();                   //sync means a complete event.
        }
        queue_self_to_delayed_workqueue(delay);
    }
</pre>
<p>In this implemention, above all issues are fixed.</p>
<p>1. use a delayed workqueue, we can cancel the queued work to stop the&nbsp;wokequeue looping. It is very easy to control.</p>
<p>2. if there is one or two event up in the figer move(figer gesture),&nbsp;the timeout will not expired, so the move is continue until user&nbsp;really want to leave their figure off the touchscreen.</p>
<p>I'm very happen that our touchscreen have a better touch feelling like&nbsp;the top level of the industry such as iPad. :)</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-post " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://www.thinksrc.com/2010/04/21/git-am.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jiejing Zhang">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://avatars0.githubusercontent.com/u/113606?v=3&s=460">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Thinking beyond source code">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2010/04/21/git-am.html" itemprop="url">git: 如何用git-am来合并git format-patch生成的一系列的patch.</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2010-04-21T21:38:06+08:00">
                2010-04-21
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/未分类/" itemprop="url" rel="index">
                    <span itemprop="name">未分类</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>这篇文章主要介绍一下git-am 和 format-patch 的使用。 因为在git使用当中，<br> 会有很多时候别人（供应商或者其他的开发人员）发过来一系列的patch，这些patch通常的是类似这样的名字：</p>
<pre class="example">0001--JFFS2-community-fix-with-not-use-OOB.patch
0002--Community-patch-for-Fix-mount-error-in.patch
0003--partial-low-interrupt-latency-mode-for-ARM113.patch
0004--for-the-global-I-cache-invalidation-ARM11.patch
0005--1-arm-Add-more-cache-memory-types-macr.patch
0006--2-Port-imx-3.3.0-release-to-2.6.28.patch
0007--3-Add-MX25-support.patch
0008--Move-asm-arch-headers-to-linux-inc-dir.patch
0009--1-regulator-allow-search-by-regulator.patch
</pre>
<p>里面包含了提交的日志，作者，日期等信息。你想做的是把这些patch引入到你的<br> 代码库中，最好是也可以把日志也引入进来， 方便以后维护用。传统的打patch方式是</p>
<pre class="example">patch -p1 &lt; 0001--JFFS2-community-fix-with-not-use-OOB.patch
</pre>
<p>这样来打patch，但是这样会把这些有用的信息丢失。</p>
<p>由于这些patch显然是用git format-patch来生成的，所以用git的工具应该就可以很好的做好。</p>
<p>git-am 就是作这件事情。</p>
<p>在使用git-am之前， 你要首先git am &ndash;abort 一次，来放弃掉以前的am信息，这样才可以进行一次全新的am。<br> 不然会遇到这样的错误。<br> <code>.git/rebase-apply still exists but mbox given.</code></p>
<p>git-am 可以一次合并一个文件，或者一个目录下所有的patch，或者你的邮箱目录下的patch.</p>
<p>下面举两个例子：</p>
<ol>
<li> 你现在有一个code base： small-src, 你的patch文件放在~/patch/0001-trival-patch.patch
<p>&nbsp;</p>
</li>
</ol>
<pre class="example">cd small-src
git-am ~/patch/0001-trival-patch.patch
</pre>
<p>如果成功patch上去， 你就可以去喝杯茶了。</p>
<p>如果失败了， git 会提示错误， 比如：</p>
<pre class="example">error: patch failed: android/mediascanner.cpp:452
error: android/mediascanner.cpp: patch does not apply
</pre>
<p>这样你就需要先看看patch， 然后改改错误的这个文件，让这个patch能够patch上去。</p>
<ol>
<li> 你有一堆patch， 名字是上面提到的那一堆patch， 你把他们放在~/patch-set/目录下（路径随意）
<p>&nbsp;</p>
</li>
</ol>
<pre class="example">cd opencore
git am ~/patch-set/*.patch
</pre>
<p>(这里git就会按照文件名的顺序一次am这些patch）<br> 如果一切顺利， 你所有的patch都OK了， 你又Lucky了。</p>
<p>不过不顺利的时候十有八九，如果git am中间遇到了patch,am就会停到打这个<br> patch的地方， 告诉你是哪个patch打不上去。</p>
<p>比如我现在有一个文件file,有两个patch.<br> file 的内容是</p>
<pre class="example">the text

more text
</pre>
<p>两个patch分别是：</p>
<p>0001-add-line.patch:</p>
<pre class="example">From 48869ccbced494e05738090afa5a54f2a261df0f Mon Sep 17 00:00:00 2001
From: zhangjiejing &lt;zhangjiejing@zhangjiejing-desktop.(none)&gt;
Date: Thu, 22 Apr 2010 13:04:34 +0800
Subject: [PATCH 1/2] add line

---
 file |    2 ++
 1 files changed, 2 insertions(+), 0 deletions(-)

diff --git a/file b/file
index 067780e..685f0fa 100644
--- a/file
+++ b/file
@@ -3,3 +3,5 @@ file:
 some text

 more text
+
+add line
--
1.6.3.3
</pre>
<p>0002-change-line.patch:</p>
<pre class="example">From f756e1b3a87c216b7e0afea9d15badd033171578 Mon Sep 17 00:00:00 2001
From: zhangjiejing &lt;zhangjiejing@zhangjiejing-desktop.(none)&gt;
Date: Thu, 22 Apr 2010 13:05:19 +0800
Subject: [PATCH 2/2] change line

---
 file |    2 +-
 1 files changed, 1 insertions(+), 1 deletions(-)

diff --git a/file b/file
index 685f0fa..7af7852 100644
--- a/file
+++ b/file
@@ -1,6 +1,6 @@
 file:

-some text
+Change line text

 more text

--
1.6.3.3
</pre>
<p>运行<br> git am *.patch</p>
<p>来merge这些patch， 报错， Patch failed at 0001 add line这样我们看0001这<br> 个patch,原来patch需要的是some text, 而file里面是the text, 所以我们用编<br> 辑器把这行改成some text,</p>
<pre class="example">vi file
git apply 0001-add-line.patch
git add file
git am --resolved
</pre>
<p>在解决完冲突以后， 比如用git add来让git知道你已经解决完冲突了。</p>
<ul>
<li> 如果你发现这个冲突是无法解决的， 要撤销整个am的东西。 可以运行git am &ndash;abort， </li>
<li> 如果你想只是忽略这一个patch，可以运行git am &ndash;skip来跳过这个patch. </li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-post " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://www.thinksrc.com/2010/04/18/suspend-cn.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jiejing Zhang">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://avatars0.githubusercontent.com/u/113606?v=3&s=460">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Thinking beyond source code">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2010/04/18/suspend-cn.html" itemprop="url">Linux Kernel and Android 休眠与唤醒(中文版)</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2010-04-18T03:55:45+08:00">
                2010-04-18
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/未分类/" itemprop="url" rel="index">
                    <span itemprop="name">未分类</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>Table of Contents</p>
<div id="table-of-contents">
<div id="text-table-of-contents">
<ul>
<li><a href="#sec-1">简介</a></li>
<li><a href="#sec-2">国际化</a></li>
<li><a href="#sec-3">版本信息</a></li>
<li><a href="#sec-4">对于休眠(suspend)的简单介绍</a></li>
<li><a href="#sec-5">Linux Suspend 的流程</a>
<ul>
<li><a href="#sec-5.1">相关的文件:</a></li>
<li><a href="#sec-5.2">准备, 冻结进程</a></li>
<li><a href="#sec-5.3">让外设进入休眠</a></li>
<li><a href="#sec-5.4">Resume</a></li>
</ul>
</li>
<li><a href="#sec-6">Android 休眠(suspend)</a>
<ul>
<li><a href="#sec-6.1">涉及到的文件:</a></li>
<li><a href="#sec-6.2">特性介绍</a>
<ul>
<li><a href="#sec-6.2.1">Early Suspend</a></li>
<li><a href="#sec-6.2.2">Late Resume</a></li>
<li><a href="#sec-6.2.3">Wake Lock</a></li>
</ul>
</li>
<li><a href="#sec-6.3">Android Suspend</a></li>
<li><a href="#sec-6.4">Early Suspend</a></li>
<li><a href="#sec-6.5">Late Resume</a></li>
<li><a href="#sec-6.6">Wake Lock</a></li>
<li><a href="#sec-6.7">Suspend</a></li>
<li><a href="#sec-6.8">Android于标准Linux休眠的区别</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="outline-container-1" class="outline-2">
<h2 id="sec-1">简介</h2>
<div id="text-1" class="outline-text-2">
<p>休眠/唤醒在嵌入式Linux中是非常重要的部分,嵌入式设备尽可能的进入休眠状 态来延长电池的续航时间.这篇文章就详细介绍一下Linux中休眠/唤醒是如何工作 的, 还有Android中如何把这部分和Linux的机制联系起来的.</p>
</div>
</div>
<div id="outline-container-2" class="outline-2">
<h2 id="sec-2">国际化</h2>
<div id="text-2" class="outline-text-2">
<ul>
<li>English Version: <a href="http://www.thinksrc.com/2010/11/20/suspend-en.html" target="_blank">link</a></li>
<li>中文版: <a href="http://www.thinksrc.com/2010/04/18/suspend-cn.html" target="_blank">link</a></li>
</ul>
</div>
</div>
<div id="outline-container-3" class="outline-2">
<p>作者: zhangjiejing &lt;kzjeef#gmail.com&gt;  Date: 2010-04-07, <a href="../">http://www.thinksrc.com<br>
</a></p>
<h2>版本信息</h2>
<div id="text-3" class="outline-text-2">
<ul>
<li>Linux Kernel: v2.6.28</li>
<li>Android: v2.0</li>
</ul>
</div>
</div>
<div id="outline-container-4" class="outline-2">
<h2 id="sec-4">对于休眠(suspend)的简单介绍</h2>
<div id="text-4" class="outline-text-2">
<p>在Linux中,休眠主要分三个主要的步骤:</p>
<ol>
<li>冻结用户态进程和内核态任务</li>
<li>调用注册的设备的suspend的回调函数
<ul>
<li>顺序是按照注册顺序</li>
</ul>
</li>
<li>休眠核心设备和使CPU进入休眠态冻结进程是内核把进程列表中所有的进程的状态都设置为停止,并且保存下所有进程的上下文. 当这些进程被解冻的时候,他们是不知道自己被冻结过的,只是简单的继续执行.如何让Linux进入休眠呢?用户可以通过读写sys文件/sys /power/state 是实现控制系统进入休眠. 比如
<pre class="example" style="background-color: #f3f5f7; font-family: courier, monospace; font-size: 14px; overflow-x: auto; overflow-y: auto; padding: 5pt; border: 1pt solid #aebdcc;"># echo standby &gt; /sys/power/state</pre>
<p>命令系统进入休眠. 也可以使用</p>
<pre class="example" style="background-color: #f3f5f7; font-family: courier, monospace; font-size: 14px; overflow-x: auto; overflow-y: auto; padding: 5pt; border: 1pt solid #aebdcc;"># cat /sys/power/state</pre>
<p>来得到内核支持哪几种休眠方式.</p></li>
</ol>
</div>
</div>
<div id="outline-container-5" class="outline-2">
<h2 id="sec-5">Linux Suspend 的流程</h2>
<div id="outline-container-5.1" class="outline-3">
<h3 id="sec-5.1"><strong>相关的文件:</strong></h3>
<div id="text-5.1" class="outline-text-3">
<p><strong>你可以通过访问 <a href="http://www.kernel.org/" target="_blank" rel="external">Linux内核网站</a> 来得到源代码,下面是文件的路径:</strong></p>
<ul>
<li>linux_soruce/kernel/power/main.c</li>
<li>linux_source/kernel/arch/xxx/mach-xxx/pm.c</li>
<li>linux_source/driver/base/power/main.c</li>
</ul>
<p>接下来让我们详细的看一下Linux是怎么休眠/唤醒的. Let 's going to see how these happens.</p>
<p>用户对于/sys/power/state 的读写会调用到 main.c中的state_store(), 用户可以写入 const char * const pm_state[] 中定义的字符串, 比如"mem", "standby".</p>
<p>然后state_store()会调用enter_state(), 它首先会检查一些状态参数,然后同步文件系统. 下面是代码:</p>
<pre class="example" style="background-color: #f3f5f7; font-family: courier, monospace; font-size: 14px; overflow-x: auto; overflow-y: auto; padding: 5pt; border: 1pt solid #aebdcc;">/**
 *      enter_state - Do common work of entering low-power state.
 *      @state:         pm_state structure for state we're entering.
 *
 *      Make sure we're the only ones trying to enter a sleep state. Fail
 *      if someone has beat us to it, since we don't want anything weird to
 *      happen when we wake up.
 *      Then, do the setup for suspend, enter the state, and cleaup (after
 *      we've woken up).
 */
static int enter_state(suspend_state_t state)
{
        int error;

        if (!valid_state(state))
                return -ENODEV;

        if (!mutex_trylock(&amp;pm_mutex))
                return -EBUSY;

        printk(KERN_INFO "PM: Syncing filesystems ... ");
        sys_sync();
        printk("done.n");

        pr_debug("PM: Preparing system for %s sleepn", pm_states[state]);
        error = suspend_prepare();
        if (error)
                goto Unlock;

        if (suspend_test(TEST_FREEZER))
                goto Finish;

        pr_debug("PM: Entering %s sleepn", pm_states[state]);
        error = suspend_devices_and_enter(state);

 Finish:
        pr_debug("PM: Finishing wakeup.n");
        suspend_finish();
 Unlock:
        mutex_unlock(&amp;pm_mutex);
        return error;
}</pre>
</div>
</div>
<div id="outline-container-5.2" class="outline-3">
<h3 id="sec-5.2"><strong>准备, 冻结进程</strong></h3>
<div id="text-5.2" class="outline-text-3">
<p>当进入到suspend_prepare()中以后, 它会给suspend分配一个虚拟终端来输出信 息, 然后广播一个系统要进入suspend的Notify, 关闭掉用户态的helper进程, 然 后一次调用suspend_freeze_processes()冻结所有的进程, 这里会保存所有进程 当前的状态, 也许有一些进程会拒绝进入冻结状态, 当有这样的进程存在的时候, 会导致冻结失败,此函数就会放弃冻结进程,并且解冻刚才冻结的所有进程.</p>
<pre class="example" style="background-color: #f3f5f7; font-family: courier, monospace; font-size: 14px; overflow-x: auto; overflow-y: auto; padding: 5pt; border: 1pt solid #aebdcc;">/**
 *      suspend_prepare - Do prep work before entering low-power state.
 *
 *      This is common code that is called for each state that we're entering.
 *      Run suspend notifiers, allocate a console and stop all processes.
 */
static int suspend_prepare(void)
{
        int error;
        unsigned int free_pages;

        if (!suspend_ops || !suspend_ops-&gt;enter)
                return -EPERM;

        pm_prepare_console();

        error = pm_notifier_call_chain(PM_SUSPEND_PREPARE);
        if (error)
                goto Finish;

        error = usermodehelper_disable();
        if (error)
                goto Finish;

        if (suspend_freeze_processes()) {
                error = -EAGAIN;
                goto Thaw;
        }

        free_pages = global_page_state(NR_FREE_PAGES);
        if (free_pages &lt; FREE_PAGE_NUMBER) {
                pr_debug("PM: free some memoryn");
                shrink_all_memory(FREE_PAGE_NUMBER - free_pages);
                if (nr_free_pages() &lt; FREE_PAGE_NUMBER) {
                        error = -ENOMEM;
                        printk(KERN_ERR "PM: No enough memoryn");
                }
        }
        if (!error)
                return 0;

 Thaw:
        suspend_thaw_processes();
        usermodehelper_enable();
 Finish:
        pm_notifier_call_chain(PM_POST_SUSPEND);
        pm_restore_console();
        return error;
}</pre>
</div>
</div>
<div id="outline-container-5.3" class="outline-3">
<h3 id="sec-5.3"><strong>让外设进入休眠</strong></h3>
<div id="text-5.3" class="outline-text-3">
<p>现在, 所有的进程(也包括workqueue/kthread) 都已经停止了, 内核态人物有 可能在停止的时候握有一些信号量, 所以如果这时候在外设里面去解锁这个信号 量有可能会发生死锁, 所以在外设的suspend()函数里面作lock/unlock锁要非常 小心,这里建议设计的时候就不要在suspend()里面等待锁. 而且因为suspend的时候,有一些Log是无法输出的,所以一旦出现问题,非常难调试.</p>
<p>然后kernel在这里会尝试释放一些内存.</p>
<p>最后会调用suspend_devices_and_enter()来把所有的外设休眠, 在这个函数中, 如果平台注册了suspend_pos(通常是在板级定义中定义和注册), 这里就会调用 suspend_ops-&gt;begin(), 然后driver/base/power/main.c 中的 device_suspend()-&gt;dpm_suspend() 会被调用,他们会依次调用驱动的suspend() 回调来休眠掉所有的设备.</p>
<p>当所有的设备休眠以后, suspend_ops-&gt;prepare()会被调用, 这个函数通常会作 一些准备工作来让板机进入休眠. 接下来Linux,在多核的CPU中的非启动CPU会被关掉, 通过注释看到是避免这些其他的CPU造成race condion,接下来的以后只有一个CPU在运行了.</p>
<p>suspend_ops 是板级的电源管理操作, 通常注册在文件 arch/xxx/mach-xxx/pm.c 中.</p>
<p>接下来, suspend_enter()会被调用, 这个函数会关闭arch irq, 调用 device_power_down(), 它会调用suspend_late()函数, 这个函数是系统真正进入 休眠最后调用的函数, 通常会在这个函数中作最后的检查. 如果检查没问题, 接 下来休眠所有的系统设备和总线, 并且调用 suspend_pos-&gt;enter() 来使CPU进入 省电状态. 这时候,就已经休眠了.代码的执行也就停在这里了.</p>
<pre class="example" style="background-color: #f3f5f7; font-family: courier, monospace; font-size: 14px; overflow-x: auto; overflow-y: auto; padding: 5pt; border: 1pt solid #aebdcc;">/**
 *      suspend_devices_and_enter - suspend devices and enter the desired system
 *                                  sleep state.
 *      @state:           state to enter
 */
int suspend_devices_and_enter(suspend_state_t state)
{
        int error, ftrace_save;

        if (!suspend_ops)
                return -ENOSYS;

        if (suspend_ops-&gt;begin) {
                error = suspend_ops-&gt;begin(state);
                if (error)
                        goto Close;
        }
        suspend_console();
        ftrace_save = __ftrace_enabled_save();
        suspend_test_start();
        error = device_suspend(PMSG_SUSPEND);
        if (error) {
                printk(KERN_ERR "PM: Some devices failed to suspendn");
                goto Recover_platform;
        }
        suspend_test_finish("suspend devices");
        if (suspend_test(TEST_DEVICES))
                goto Recover_platform;

        if (suspend_ops-&gt;prepare) {
                error = suspend_ops-&gt;prepare();
                if (error)
                        goto Resume_devices;
        }

        if (suspend_test(TEST_PLATFORM))
                goto Finish;

        error = disable_nonboot_cpus();
        if (!error &amp;&amp; !suspend_test(TEST_CPUS))
                suspend_enter(state);

        enable_nonboot_cpus();
 Finish:
        if (suspend_ops-&gt;finish)
                suspend_ops-&gt;finish();
 Resume_devices:
        suspend_test_start();
        device_resume(PMSG_RESUME);
        suspend_test_finish("resume devices");
        __ftrace_enabled_restore(ftrace_save);
        resume_console();
 Close:
        if (suspend_ops-&gt;end)
                suspend_ops-&gt;end();
        return error;

 Recover_platform:
        if (suspend_ops-&gt;recover)
                suspend_ops-&gt;recover();
        goto Resume_devices;
}</pre>
</div>
</div>
<div id="outline-container-5.4" class="outline-3">
<h3 id="sec-5.4"><strong>Resume</strong></h3>
<div id="text-5.4" class="outline-text-3">
<p>如果在休眠中系统被中断或者其他事件唤醒, 接下来的代码就会开始执行, 这个 唤醒的顺序是和休眠的循序相反的,所以系统设备和总线会首先唤醒,使能系统中 断, 使能休眠时候停止掉的非启动CPU, 以及调用suspend_ops-&gt;finish(), 而且 在suspend_devices_and_enter()函数中也会继续唤醒每个设备,使能虚拟终端, 最后调用 suspend_ops-&gt;end().</p>
<p>在返回到enter_state()函数中的, 当 suspend_devices_and_enter() 返回以后, 外设已经唤醒了, 但是进程和任务都还是冻结状态, 这里会调用suspend_finish()来解冻这些进程和任务, 而且发出Notify来表示系统已经从suspend状态退出, 唤醒终端.</p>
<p>到这里, 所有的休眠和唤醒就已经完毕了, 系统继续运行了.</p>
</div>
</div>
</div>
<div id="outline-container-6" class="outline-2">
<h2 id="sec-6">Android 休眠(suspend)</h2>
<div id="text-6" class="outline-text-2">
<p>在一个打过android补丁的内核中, state_store()函数会走另外一条路,会进 入到request_suspend_state()中, 这个文件在earlysuspend.c中. 这些功能都 是android系统加的, 后面会对earlysuspend和late resume 进行介绍.</p>
</div>
<div id="outline-container-6.1" class="outline-3">
<h3 id="sec-6.1">涉及到的文件:</h3>
<div id="text-6.1" class="outline-text-3">
<ul>
<li>linux_source/kernel/power/main.c</li>
<li>linux_source/kernel/power/earlysuspend.c</li>
<li>linux_source/kernel/power/wakelock.c</li>
</ul>
</div>
</div>
<div id="outline-container-6.2" class="outline-3">
<h3 id="sec-6.2"><strong>特性介绍</strong></h3>
<div id="outline-container-6.2.1" class="outline-4">
<h4 id="sec-6.2.1">Early Suspend</h4>
<div id="text-6.2.1" class="outline-text-4">
<p>Early suspend 是android 引进的一种机制, 这种机制在上游备受争议,这里 不做评论. 这个机制作用在关闭显示的时候, 在这个时候, 一些和显示有关的 设备, 比如LCD背光, 比如重力感应器, 触摸屏, 这些设备都会关掉, 但是系 统可能还是在运行状态(这时候还有wake lock)进行任务的处理, 例如在扫描 SD卡上的文件等. 在嵌入式设备中, 背光是一个很大的电源消耗,所以 android会加入这样一种机制.</p>
</div>
</div>
<div id="outline-container-6.2.2" class="outline-4">
<h4 id="sec-6.2.2">Late Resume</h4>
<div id="text-6.2.2" class="outline-text-4">
<p>Late Resume 是和suspend 配套的一种机制, 是在内核唤醒完毕开始执行的. 主要就是唤醒在Early Suspend的时候休眠的设备.</p>
</div>
</div>
<div id="outline-container-6.2.3" class="outline-4">
<h4 id="sec-6.2.3">Wake Lock</h4>
<div id="text-6.2.3" class="outline-text-4">
<p>Wake Lock 在Android的电源管理系统中扮演一个核心的角色. Wake Lock是一种锁的机制, 只要有人拿着这个锁, 系统就无法进入休眠, 可以被用户态程序和内核获得. 这个锁可以是有超时的或者是没有超时的, 超时的锁会在时间过去以后自动解锁. 如果没有锁了或者超时了, 内核就会启动休眠的那套机制来进入休眠.</p>
</div>
</div>
</div>
<div id="outline-container-6.3" class="outline-3">
<h3 id="sec-6.3"><strong>Android Suspend</strong></h3>
<div id="text-6.3" class="outline-text-3">
<p>当用户写入mem 或者 standby到 /sys/power/state中的时候, state_store()会被调用, 然后Android会在这里调用 request_suspend_state() 而标准的Linux会在这里进入enter_state()这个函数. 如果请求的是休眠, 那么early_suspend这个workqueue就会被调用,并且进入early_suspend状态.</p>
<pre class="example" style="background-color: #f3f5f7; font-family: courier, monospace; font-size: 14px; overflow-x: auto; overflow-y: auto; padding: 5pt; border: 1pt solid #aebdcc;">void request_suspend_state(suspend_state_t new_state)
{
        unsigned long irqflags;
        int old_sleep;

        spin_lock_irqsave(&amp;state_lock, irqflags);
        old_sleep = state &amp; SUSPEND_REQUESTED;
        if (debug_mask &amp; DEBUG_USER_STATE) {
                struct timespec ts;
                struct rtc_time tm;
                getnstimeofday(&amp;ts);
                rtc_time_to_tm(ts.tv_sec, &amp;tm);
                pr_info("request_suspend_state: %s (%d-&gt;%d) at %lld "
                        "(%d-%02d-%02d %02d:%02d:%02d.%09lu UTC)n",
                        new_state != PM_SUSPEND_ON ? "sleep" : "wakeup",
                        requested_suspend_state, new_state,
                        ktime_to_ns(ktime_get()),
                        tm.tm_year + 1900, tm.tm_mon + 1, tm.tm_mday,
                        tm.tm_hour, tm.tm_min, tm.tm_sec, ts.tv_nsec);
        }
        if (!old_sleep &amp;&amp; new_state != PM_SUSPEND_ON) {
                state |= SUSPEND_REQUESTED;
                queue_work(suspend_work_queue, &amp;early_suspend_work);
        } else if (old_sleep &amp;&amp; new_state == PM_SUSPEND_ON) {
                state &amp;= ~SUSPEND_REQUESTED;
                wake_lock(&amp;main_wake_lock);
                queue_work(suspend_work_queue, &amp;late_resume_work);
        }
        requested_suspend_state = new_state;
        spin_unlock_irqrestore(&amp;state_lock, irqflags);
}</pre>
</div>
</div>
<div id="outline-container-6.4" class="outline-3">
<h3 id="sec-6.4"><strong>Early Suspend</strong></h3>
<div id="text-6.4" class="outline-text-3">
<p>在early_suspend()函数中, 首先会检查现在请求的状态还是否是suspend, 来 防止suspend的请求会在这个时候取消掉(因为这个时候用户进程还在运行),如 果需要退出, 就简单的退出了. 如果没有, 这个函数就会把early suspend中 注册的一系列的回调都调用一次, 然后同步文件系统, 然后放弃掉 main_wake_lock, 这个wake lock是一个没有超时的锁,如果这个锁不释放, 那 么系统就无法进入休眠.</p>
<pre class="example" style="background-color: #f3f5f7; font-family: courier, monospace; font-size: 14px; overflow-x: auto; overflow-y: auto; padding: 5pt; border: 1pt solid #aebdcc;">   static void early_suspend(struct work_struct *work)
{
        struct early_suspend *pos;
        unsigned long irqflags;
        int abort = 0;

        mutex_lock(&amp;early_suspend_lock);
        spin_lock_irqsave(&amp;state_lock, irqflags);
        if (state == SUSPEND_REQUESTED)
                state |= SUSPENDED;
        else
                abort = 1;
        spin_unlock_irqrestore(&amp;state_lock, irqflags);

        if (abort) {
                if (debug_mask &amp; DEBUG_SUSPEND)
                        pr_info("early_suspend: abort, state %dn", state);
                mutex_unlock(&amp;early_suspend_lock);
                goto abort;
        }

        if (debug_mask &amp; DEBUG_SUSPEND)
                pr_info("early_suspend: call handlersn");
        list_for_each_entry(pos, &amp;early_suspend_handlers, link) {
                if (pos-&gt;suspend != NULL)
                        pos-&gt;suspend(pos);
        }
        mutex_unlock(&amp;early_suspend_lock);

        if (debug_mask &amp; DEBUG_SUSPEND)
                pr_info("early_suspend: syncn");

        sys_sync();
abort:
        spin_lock_irqsave(&amp;state_lock, irqflags);
        if (state == SUSPEND_REQUESTED_AND_SUSPENDED)
                wake_unlock(&amp;main_wake_lock);
        spin_unlock_irqrestore(&amp;state_lock, irqflags);
}</pre>
</div>
</div>
<div id="outline-container-6.5" class="outline-3">
<h3 id="sec-6.5"><strong>Late Resume</strong></h3>
<div id="text-6.5" class="outline-text-3">
<p>当所有的唤醒已经结束以后, 用户进程都已经开始运行了, 唤醒通常会是以下的几种原因:</p>
<ul>
<li>来电</li>
</ul>
<p>如果是来电, 那么Modem会通过发送命令给rild来让rild通知WindowManager有 来电响应,这样就会远程调用PowerManagerService来写"on" 到 /sys/power/state 来执行late resume的设备, 比如点亮屏幕等.</p>
<ul>
<li>用户按键用户按键事件会送到WindowManager中, WindowManager会处理这些 按键事件,按键分为几种情况, 如果案件不是唤醒键(能够唤醒系统的按键) 那么WindowManager会主动放弃wakeLock来使系统进入再次休眠, 如果按键 是唤醒键,那么WindowManger就会调用PowerManagerService中的接口来执行 Late Resume.</li>
<li>Late Resume 会依次唤醒前面调用了Early Suspend的设备.</li>
</ul>
<pre class="example" style="background-color: #f3f5f7; font-family: courier, monospace; font-size: 14px; overflow-x: auto; overflow-y: auto; padding: 5pt; border: 1pt solid #aebdcc;">static void late_resume(struct work_struct *work)
{
        struct early_suspend *pos;
        unsigned long irqflags;
        int abort = 0;

        mutex_lock(&amp;early_suspend_lock);
        spin_lock_irqsave(&amp;state_lock, irqflags);
        if (state == SUSPENDED)
                state &amp;= ~SUSPENDED;
        else
                abort = 1;
        spin_unlock_irqrestore(&amp;state_lock, irqflags);

        if (abort) {
                if (debug_mask &amp; DEBUG_SUSPEND)
                        pr_info("late_resume: abort, state %dn", state);
                goto abort;
        }
        if (debug_mask &amp; DEBUG_SUSPEND)
                pr_info("late_resume: call handlersn");
        list_for_each_entry_reverse(pos, &amp;early_suspend_handlers, link)
                if (pos-&gt;resume != NULL)
                        pos-&gt;resume(pos);
        if (debug_mask &amp; DEBUG_SUSPEND)
                pr_info("late_resume: donen");
abort:
        mutex_unlock(&amp;early_suspend_lock);
}</pre>
</div>
</div>
<div id="outline-container-6.6" class="outline-3">
<h3 id="sec-6.6"><strong>Wake Lock</strong></h3>
<div id="text-6.6" class="outline-text-3">
<p>我们接下来看一看wake lock的机制是怎么运行和起作用的, 主要关注 wakelock.c文件就可以了.</p>
<p>wake lock 有加锁和解锁两种状态, 加锁的方式有两种, 一种是永久的锁住, 这样的锁除非显示的放开, 是不会解锁的, 所以这种锁的使用是非常小心的. 第二种是超时锁, 这种锁会锁定系统唤醒一段时间, 如果这个时间过去了, 这个锁会自动解除.</p>
<p>锁有两种类型:</p>
<ol>
<li>WAKE_LOCK_SUSPEND 这种锁会防止系统进入睡眠</li>
<li>WAKE_LOCK_IDLE 这种锁不会影响系统的休眠, 作用我不是很清楚.</li>
</ol>
<p>在wake lock中, 会有3个地方让系统直接开始suspend(), 分别是:</p>
<ol>
<li>在wake_unlock()中, 如果发现解锁以后没有任何其他的wake lock了, 就开始休眠</li>
<li>在定时器都到时间以后, 定时器的回调函数会查看是否有其他的wake lock, 如果没有, 就在这里让系统进入睡眠.</li>
<li>在wake_lock() 中, 对一个wake lock加锁以后, 会再次检查一下有没有锁, 我想这里的检查是没有必要的, 更好的方法是使加锁的这个操作原子化, 而 不是繁冗的检查. 而且这样的检查也有可能漏掉.</li>
</ol>
</div>
<div id="text-6.6" class="outline-text-3">调试wake lock的时候， 有一个很有用的方法就是</div>
<div class="outline-text-3">
<pre class="brush: bash;fontsize: 100; first-line: 1; ">echo 15 &gt; /sys/module/wakelock/parameter/debug_mask</pre>
</div>
<div class="outline-text-3">这样wakelock的驱动会把每次的wakelock操作都打印在console上，对于调试为什么suspend不下去这类的问题很有用。</div>
</div>
<div id="outline-container-6.7" class="outline-3">
<h3 id="sec-6.7"><strong>Suspend</strong></h3>
<div id="text-6.7" class="outline-text-3">
<p>当wake_lock 运行 suspend()以后, 在wakelock.c的suspend()函数会被调用,这 个函数首先sync文件系统,然后调用pm_suspend(request_suspend_state),接 下来pm_suspend()就会调用enter_state()来进入Linux的休眠流程..</p>
<pre class="example" style="background-color: #f3f5f7; font-family: courier, monospace; font-size: 14px; overflow-x: auto; overflow-y: auto; padding: 5pt; border: 1pt solid #aebdcc;">      static void suspend(struct work_struct *work)
{
        int ret;
        int entry_event_num;

        if (has_wake_lock(WAKE_LOCK_SUSPEND)) {
                if (debug_mask &amp; DEBUG_SUSPEND)
                        pr_info("suspend: abort suspendn");
                return;
        }

        entry_event_num = current_event_num;
        sys_sync();
        if (debug_mask &amp; DEBUG_SUSPEND)
                pr_info("suspend: enter suspendn");
        ret = pm_suspend(requested_suspend_state);
        if (current_event_num == entry_event_num) {
                wake_lock_timeout(&amp;unknown_wakeup, HZ / 2);
        }
}</pre>
</div>
</div>
<div id="outline-container-6.8" class="outline-3">
<h3 id="sec-6.8"><strong>Android于标准Linux休眠的区别</strong></h3>
<div id="text-6.8" class="outline-text-3">
<p>pm_suspend() 虽然会调用enter_state()来进入标准的Linux休眠流程,但是还 是有一些区别:</p>
<ul>
<li>当进入冻结进程的时候, android首先会检查有没有wake lock,如果没有, 才会停止这些进程, 因为在开始suspend和冻结进程期间有可能有人申请了 wake lock,如果是这样, 冻结进程会被中断.</li>
<li>在suspend_late()中, 会最后检查一次有没有wake lock, 这有可能是某种快速申请wake lock,并且快速释放这个锁的进程导致的,如果有这种情况, 这里会返回错误, 整个suspend就会全部放弃.如果pm_suspend()成功了,LOG的输出可以通过在kernel cmd里面增加 "<span style="line-height: 17px; font-size: 12px;"><span style="color: #000000;">no_console_suspend" 来看到suspend和resume过程中的log输出。<br>
</span></span></li>
</ul>
</div>
</div>
</div>
<p>&nbsp;</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-post " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://www.thinksrc.com/2010/04/11/dma-zone.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jiejing Zhang">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://avatars0.githubusercontent.com/u/113606?v=3&s=460">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Thinking beyond source code">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2010/04/11/dma-zone.html" itemprop="url">Config Linux DMA zone memory</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2010-04-11T23:33:38+08:00">
                2010-04-11
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/未分类/" itemprop="url" rel="index">
                    <span itemprop="name">未分类</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p></p><p>This value is about DMA zone size of Linux DMA zone size, this value &nbsp;can set in CONFIG_DMA_ZONE_SIZE,&nbsp;This value is set by kernel .config, vi your .config file to see how much,&nbsp;how kernel use this value?</p>
<p>The arch memory.h header file will use your define function named&nbsp;arch_adjust_zones() to adjust global value zone_size[] to adjust you&nbsp;custom memory zone infomation.</p>
<p>&nbsp;</p>
<p>files:</p>
<p>arch/arm/include/asm/memory.h : arch_adjust_zones</p>
<p>arch/arm/mach-xxx/include/mach/memory.h arch_adjust_zones</p>
<p>&nbsp;</p><p></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/4/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/4/">4</a><span class="page-number current">5</span><a class="page-number" href="/page/6/">6</a><span class="space">&hellip;</span><a class="page-number" href="/page/11/">11</a><a class="extend next" rel="next" href="/page/6/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="https://avatars0.githubusercontent.com/u/113606?v=3&s=460"
               alt="Jiejing Zhang" />
          <p class="site-author-name" itemprop="name">Jiejing Zhang</p>
           
              <p class="site-description motion-element" itemprop="description"></p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives/">
                <span class="site-state-item-count">110</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              
                <span class="site-state-item-count">11</span>
                <span class="site-state-item-name">分类</span>
              
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">24</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        


      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Jiejing Zhang</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.1"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.1"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.1"></script>



  
    <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.1"></script>

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.1"></script>



  


  




	





  





  





  






  





  

  

  

  
  
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      });
    </script>

    <script type="text/x-mathjax-config">
      MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      });
    </script>
    <script type="text/javascript" src="//cdn.bootcss.com/mathjax/2.7.1/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
  


  

  

</body>
</html>
